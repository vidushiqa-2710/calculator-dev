name: App Build, Unit Test, & E2E Trigger

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  unit_test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Application Code
      uses: actions/checkout@v3
      
    - name: Set up Node.js 18.x
      uses: actions/setup-node@v3
      with:
        node-version: '18.x'
        
    - name: Install Dependencies & Run Jest Unit Tests
      run: |
        npm install
        npm run test:unit

  # New Job 2: This job runs ONLY the checkout, preparing the files for the E2E runner.
  e2e_checkout:
    needs: unit_test
    if: success()
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Application Code (for Playwright to access index.html)
        # This checks out the files into the workspace that the next job will use.
        uses: actions/checkout@v3
        
  # New Job 3: This job is dedicated SOLELY to calling the reusable workflow.
  e2e_trigger_runner:
    needs: e2e_checkout # This job waits for the checkout job to finish
    if: success()
    
    # CRITICAL: When using `uses:` here, the job structure changes.
    # We remove 'runs-on' and all 'steps'.
    permissions:
      contents: read
      actions: write
      
    # This is the correct, top-level way to call a reusable workflow (no 'steps' block)
    uses: vidushiqa-2710/playwright-e2e/.github/workflows/run_tests.yml@main